{% extends "base.html" %}
{% load static %}
{% block title %}{{ petition.title }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-5">

                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —ñ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è -->
                    <div class="d-flex justify-content-between align-items-start mb-4 flex-wrap gap-3">
                        <div>
                            <h2 class="fw-bold">{{ petition.title }}</h2>
                            <p class="text-muted mb-2">{{ petition.description }}</p>
                            <p class="mb-1"><strong>–ê–≤—Ç–æ—Ä:</strong> {{ petition.creator.get_full_name }}</p>
                            <p class="mb-1"><strong>–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è:</strong> {{ petition.created_at|date:"SHORT_DATETIME_FORMAT" }}</p>
                            {% if petition.deadline %}
                                <p class="mb-1"><strong>–î–µ–¥–ª–∞–π–Ω:</strong> {{ petition.deadline|date:"SHORT_DATETIME_FORMAT" }}</p>
                            {% endif %}
                            <p>
                                <strong>–†—ñ–≤–µ–Ω—å:</strong>
                                <span class="badge bg-secondary">{{ petition.get_level_display }}</span>
                                {% if petition.class_group %}
                                    <span class="badge bg-info text-dark">–ö–ª–∞—Å: {{ petition.class_group }}</span>
                                {% endif %}
                            </p>
                        </div>
                        <a href="{% url 'petition_list' %}" class="btn btn-outline-secondary rounded-pill">‚Üê –ù–∞–∑–∞–¥ –¥–æ –ø–µ—Ç–∏—Ü—ñ–π</a>
                    </div>

                    <hr class="my-4">

                    <!-- –ë–ª–æ–∫ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ -->
                    <h5 class="mb-3">–ü—ñ–¥—Ç—Ä–∏–º–∫–∞:</h5>

                    <p><strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—ñ–¥—Ç—Ä–∏–º–∫–∏:</strong> <span id="support-count" class="fw-bold">{{ supporters_count }}</span> / {{ eligible_voters }}</p>

                    <!-- –ü—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä -->
                    <div class="progress mb-3 rounded-pill" style="height: 20px;">
                        <div class="progress-bar bg-success text-dark fw-semibold"
                             id="support-progress"
                             role="progressbar"
                             style="width: {{ support_percent }}%;"
                             aria-valuenow="{{ support_percent }}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            {{ support_percent }}%
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ -->
                    {% if can_support %}
                        <form method="post" action="{% url 'support_petition' petition.pk %}" id="support-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-primary rounded-pill">üôã –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø–µ—Ç–∏—Ü—ñ—é</button>
                        </form>
                    {% elif supported %}
                        <div class="alert alert-info rounded-3 mt-3">‚úÖ –í–∏ –≤–∂–µ –ø—ñ–¥—Ç—Ä–∏–º–∞–ª–∏ —Ü—é –ø–µ—Ç–∏—Ü—ñ—é.</div>
                    {% else %}
                        <div class="alert alert-warning rounded-3 mt-3">‚ö†Ô∏è –í–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ —Ü—é –ø–µ—Ç–∏—Ü—ñ—é.</div>
                    {% endif %}

                    <!-- –í–∏–¥–∞–ª–µ–Ω–Ω—è (–¥–æ—Å—Ç—É–ø–Ω–æ –∞–≤—Ç–æ—Ä—É, –¥–∏—Ä–µ–∫—Ç–æ—Ä—É, –∞–¥–º—ñ–Ω—É) -->
                    {% if request.user == petition.creator or request.user.role in "director admin" %}
                        <form method="post" action="{% url 'petition_delete' petition.pk %}"
                              onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ø–µ—Ç–∏—Ü—ñ—é?');"
                              class="mt-4">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger rounded-pill">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –ø–µ—Ç–∏—Ü—ñ—é</button>
                        </form>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS: –¥–∏–Ω–∞–º—ñ—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É -->
<script>
document.getElementById("support-form")?.addEventListener("submit", function(e) {
    e.preventDefault();
    fetch(this.action, {
        method: "POST",
        headers: {
            "X-CSRFToken": this.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    }).then(response => response.json())
      .then(data => {
        if (data.success) {
            const countElem = document.getElementById("support-count");
            const progressElem = document.getElementById("support-progress");
            countElem.textContent = data.supporters_count;
            progressElem.style.width = data.support_percent + "%";
            progressElem.textContent = data.support_percent + "%";
            this.remove();
        }
      });
});
</script>
{% endblock %}
