{% extends "base.html" %}
{% load static %}
{% block title %}üì¢ {{ petition.title }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-5">

                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                    <div class="d-flex justify-content-between align-items-start mb-4 flex-wrap gap-3">
                        <div>
                            <h2 class="fw-bold">üì¢ {{ petition.title }}</h2>
                            <p class="text-muted mb-2">üìù {{ petition.text }}</p>
                            <p class="mb-1">üë§ <strong>–ê–≤—Ç–æ—Ä:</strong> {{ petition.creator.get_full_name }}</p>
                            <p class="mb-1">üìÖ <strong>–°—Ç–≤–æ—Ä–µ–Ω–æ:</strong> {{ petition.created_at|date:"SHORT_DATETIME_FORMAT" }}</p>
                            {% if petition.deadline %}
                                <p class="mb-1">‚è≥ <strong>–î–µ–¥–ª–∞–π–Ω:</strong> {{ petition.deadline|date:"SHORT_DATETIME_FORMAT" }}</p>
                            {% endif %}
                            <p>
                                üè∑Ô∏è <strong>–†—ñ–≤–µ–Ω—å:</strong>
                                <span class="badge bg-secondary">{{ petition.get_level_display }}</span>
                                {% if petition.class_group %}
                                    <span class="badge bg-info text-dark">üéì –ö–ª–∞—Å: {{ petition.class_group }}</span>
                                {% endif %}
                            </p>
                        </div>
                        <a href="{% url 'petition_list' %}" class="btn btn-outline-secondary rounded-pill">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –¥–æ –ø–µ—Ç–∏—Ü—ñ–π</a>
                    </div>

                    <hr class="my-4">

                    <!-- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ -->
                    <h5 class="mb-3">üôã‚Äç‚ôÄÔ∏è –ü—ñ–¥—Ç—Ä–∏–º–∫–∞:</h5>

                    <p>
                        <strong>üî¢ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–ª–æ—Å—ñ–≤:</strong>
                        <span id="support-count" class="fw-bold">{{ supporters_count }}</span>
                        / {{ eligible_voters }}
                    </p>

                    <div class="progress mb-3 rounded-pill" style="height: 24px;">
                        <div class="progress-bar bg-success text-dark fw-semibold"
                             id="support-progress"
                             role="progressbar"
                             style="width: {{ support_percent }}%;"
                             aria-valuenow="{{ support_percent }}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            {{ support_percent }}%
                        </div>
                    </div>

                    {% if can_support or supported %}
                        <div id="support-button-wrapper">
                            <form method="post" action="{% url 'support_petition' petition.pk %}" id="support-form">
                                {% csrf_token %}
                                {% if supported %}
                                    <input type="hidden" name="cancel" value="1">
                                    <button type="submit" class="btn btn-outline-danger rounded-pill">
                                        ‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫—É
                                    </button>
                                {% else %}
                                    <button type="submit" class="btn btn-outline-primary rounded-pill">
                                        üôã –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø–µ—Ç–∏—Ü—ñ—é
                                    </button>
                                {% endif %}
                            </form>
                        </div>
                    {% else %}
                        <div class="alert alert-warning rounded-3 mt-3">
                            ‚ö†Ô∏è –í–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ —Ü—é –ø–µ—Ç–∏—Ü—ñ—é.
                        </div>
                    {% endif %}

                    {% if request.user == petition.creator or request.user.role in "director admin" %}
                        <form method="post" action="{% url 'petition_delete' petition.pk %}"
                              onsubmit="return confirm('‚ùó –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ø–µ—Ç–∏—Ü—ñ—é?');"
                              class="mt-4">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger rounded-pill">
                                üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –ø–µ—Ç–∏—Ü—ñ—é
                            </button>
                        </form>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS: –î–∏–Ω–∞–º—ñ—á–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ / —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const formWrapper = document.getElementById("support-button-wrapper");
    const countElem = document.getElementById("support-count");
    const progressElem = document.getElementById("support-progress");

    formWrapper?.addEventListener("submit", function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const isCancel = formData.get("cancel");

        fetch(form.action, {
            method: "POST",
            headers: {
                "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: formData
        }).then(response => response.json())
          .then(data => {
            if (data.success) {
                // –û–Ω–æ–≤–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —ñ –ø—Ä–æ–≥—Ä–µ—Å
                countElem.textContent = data.supporters_count;
                progressElem.style.width = data.support_percent + "%";
                progressElem.setAttribute("aria-valuenow", data.support_percent);
                progressElem.textContent = data.support_percent + "%";

                // –ó–º—ñ–Ω–∏—Ç–∏ –∫–Ω–æ–ø–∫—É
                const newForm = document.createElement("form");
                newForm.method = "post";
                newForm.action = form.action;
                newForm.id = "support-form";

                const csrf = document.createElement("input");
                csrf.type = "hidden";
                csrf.name = "csrfmiddlewaretoken";
                csrf.value = form.querySelector('[name=csrfmiddlewaretoken]').value;
                newForm.appendChild(csrf);

                const btn = document.createElement("button");
                btn.type = "submit";
                btn.className = "btn rounded-pill " + (isCancel ? "btn-outline-primary" : "btn-outline-danger");
                btn.innerHTML = isCancel ? "üôã –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø–µ—Ç–∏—Ü—ñ—é" : "‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫—É";

                if (!isCancel) {
                    const hidden = document.createElement("input");
                    hidden.type = "hidden";
                    hidden.name = "cancel";
                    hidden.value = "1";
                    newForm.appendChild(hidden);
                }

                newForm.appendChild(btn);
                formWrapper.innerHTML = "";
                formWrapper.appendChild(newForm);
            }
          });
    });
});
</script>
{% endblock %}
