{% extends "base.html" %}
{% load static %}
{% block title %}üì¢ {{ petition.title }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-5">

                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                    <div class="d-flex justify-content-between align-items-start mb-4 flex-wrap gap-3">
                        <div>
                            <h2 class="fw-bold">üì¢ {{ petition.title }}</h2>
                            <p class="text-muted mb-2">üìù {{ petition.text }}</p>
                            <p class="mb-1">üë§ <strong>–ê–≤—Ç–æ—Ä:</strong> {{ petition.creator.get_full_name }}
                                <span class="text-muted">({{ petition.creator.role }})</span>
                                {% if request.user == petition.creator %}
                                    <span class="badge bg-secondary">–í–∏</span>
                                {% endif %}
                            </p>
                            <p class="mb-1">üìÖ <strong>–°—Ç–≤–æ—Ä–µ–Ω–æ:</strong> {{ petition.created_at|date:"d E Y, H:i" }}</p>
                            {% if petition.deadline %}
                                <p class="mb-1">‚è≥ <strong>–î–µ–¥–ª–∞–π–Ω:</strong> {{ petition.deadline|date:"d E Y, H:i" }}</p>
                            {% endif %}
                            <p>
                                üè∑Ô∏è <strong>–†—ñ–≤–µ–Ω—å:</strong>
                                <span class="badge bg-secondary">{{ petition.get_level_display }}</span>
                                {% if petition.class_group %}
                                    <span class="badge bg-info text-dark">üéì –ö–ª–∞—Å: {{ petition.class_group }}</span>
                                {% endif %}
                            </p>
                            <p class="mt-3">
                                <strong>üìå –°—Ç–∞—Ç—É—Å –ø–µ—Ç–∏—Ü—ñ—ó:</strong>
                                {% if petition.status == 'new' %}
                                    <span class="badge bg-warning text-dark">–ù–æ–≤–∞</span>
                                {% elif petition.status == 'pending' %}
                                    <span class="badge bg-info text-dark">–û—á—ñ–∫—É—î—Ç—å—Å—è</span>
                                {% elif petition.status == 'accepted' %}
                                    <span class="badge bg-success">‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∞</span>
                                {% elif petition.status == 'rejected' %}
                                    <span class="badge bg-danger">‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–∞</span>
                                {% endif %}
                        </p>
                        </div>
                        <a href="{% url 'petition_list' %}" class="btn btn-outline-secondary rounded-pill">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –¥–æ –ø–µ—Ç–∏—Ü—ñ–π</a>
                    </div>

                    <hr class="my-4">

                    <!-- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ -->
                    <h5 class="mb-3">üôã‚Äç‚ôÄÔ∏è –ü—ñ–¥—Ç—Ä–∏–º–∫–∞:</h5>

                    <p>
                        <strong>üî¢ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–ª–æ—Å—ñ–≤:</strong>
                        <span id="support-count" class="fw-bold">{{ supporters_count }}</span>
                        / {{ eligible_voters }}
                    </p>

                    <div class="progress mb-3 rounded-pill" style="height: 24px;">
                        <div class="progress-bar fw-semibold text-white"
                             id="support-progress"
                             role="progressbar"
                             style="width: {{ support_percent }}%; background: linear-gradient(90deg, #00c6ff, #0072ff); transition: width 0.6s ease;"
                             aria-valuenow="{{ support_percent }}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            {{ support_percent }}%
                        </div>
                    </div>
                    <p>
                        <strong>üìà –ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è —Ä–æ–∑–≥–ª—è–¥—É:</strong> {{ required_supporters }} –≥–æ–ª–æ—Å—ñ–≤<br>
                        <strong>üîÅ –ó–∞–ª–∏—à–∏–ª–æ—Å—å –∑—ñ–±—Ä–∞—Ç–∏:</strong> {{ remaining_supporters }}
                    </p>
                    <!-- –ü—ñ—Å–ª—è –±–ª–æ–∫—É "–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è —Ä–æ–∑–≥–ª—è–¥—É" -->


                    {% if request.user.role == 'director' and support_percent >= 50 and petition.status == 'pending' %}
                        <div class="mt-4">
                            <h5>‚öôÔ∏è –î—ñ—ó –∑ –ø–µ—Ç–∏—Ü—ñ—î—é:</h5>
                            <form method="post" action="{% url 'petition_set_status' petition.pk %}" class="d-flex gap-2 flex-wrap mt-2">
                                {% csrf_token %}
                                <button name="status" value="accepted" class="btn btn-success rounded-pill" onclick="return confirm('‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏ –ø–µ—Ç–∏—Ü—ñ—é?')">
                                    ‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏
                                </button>
                                <button name="status" value="rejected" class="btn btn-danger rounded-pill" onclick="return confirm('‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏ –ø–µ—Ç–∏—Ü—ñ—é?')">
                                    ‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏
                                </button>
                            </form>
                        </div>
                    {% endif %}




                    {% if can_support or supported %}
                        <div id="support-button-wrapper"
                             data-support-url="{% url 'support_petition' petition.pk %}">
                            <form method="post" action="{% url 'support_petition' petition.pk %}" id="support-form">
                                {% csrf_token %}
                                {% if supported %}
                                    <input type="hidden" name="cancel" value="1">
                                    <button type="submit" class="btn btn-outline-danger rounded-pill">
                                        ‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫—É
                                    </button>
                                {% else %}
                                    <button type="submit" class="btn btn-outline-primary rounded-pill">
                                        üôã –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø–µ—Ç–∏—Ü—ñ—é
                                    </button>
                                {% endif %}
                            </form>
                        </div>
                    {% else %}
                        <div id="support-button-wrapper"
                         data-support-url="{% url 'support_petition' petition.pk %}"></div>
                        <div class="alert alert-warning rounded-3 mt-3">
                            ‚ö†Ô∏è –í–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ —Ü—é –ø–µ—Ç–∏—Ü—ñ—é.
                        </div>
                    {% endif %}

                    {% if request.user == petition.creator or request.user.role in "director admin" %}
                        <form method="post" action="{% url 'petition_delete' petition.pk %}"
                              onsubmit="return confirm('‚ùó –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ø–µ—Ç–∏—Ü—ñ—é?');"
                              class="mt-4">
                            {% csrf_token %}
                            {% if request.user == petition.creator %}
                                <button type="submit" class="btn btn-danger rounded-pill">
                                    üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –ø–µ—Ç–∏—Ü—ñ—é
                                </button>
                            {% endif %}
                        </form>
                    {% endif %}

                    <hr class="my-4">

                    <!-- –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ -->
                    <h5 class="mb-3">üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ:</h5>

                    <button class="btn btn-outline-success rounded-pill mb-4" data-bs-toggle="modal" data-bs-target="#commentModal">
                        ‚ûï –î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä
                    </button>

                    <div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content rounded-4 shadow">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="commentModalLabel">üí¨ –ù–æ–≤–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
                                </div>
                                <form method="post" action="{% url 'add_comment' petition.pk %}">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <textarea name="text" rows="4" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à –∫–æ–º–µ–Ω—Ç–∞—Ä..." required></textarea>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                        <button type="submit" class="btn btn-primary rounded-pill">üí¨ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    {% if comments %}
                        <div class="list-group">
                            {% for comment in comments %}
                                <div class="list-group-item mb-3 border rounded-4 p-3 bg-light position-relative fade-in">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <strong>{{ comment.author.get_full_name }} <span class="text-muted">({{ comment.author.role }})</span></strong>
                                        <small class="text-muted">
                                            üìÖ {{ comment.created_at|date:"d E Y, H:i" }}
                                        </small>
                                    </div>

                                    <p class="mb-2">{{ comment.text }}</p>

                                    <div class="d-flex justify-content-between align-items-end">
                                        {% if comment.was_edited %}
                                            <small class="text-muted fst-italic">
                                                üìù –†–µ–¥–∞–≥–æ–≤–∞–Ω–æ: {{ comment.updated_at|date:"d E Y, H:i" }}
                                            </small>
                                        {% else %}
                                            <span></span>
                                        {% endif %}

                                        {% if comment.author == request.user %}
                                            <div class="d-flex gap-2 mt-1">
                                                <button class="btn btn-sm btn-light rounded-circle border"
                                                        title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#editCommentModal-{{ comment.pk }}">
                                                    ‚úèÔ∏è
                                                </button>
                                                <form method="post" action="{% url 'delete_comment' petition.pk comment.pk %}"
                                                      onsubmit="return confirm('‚ùó –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä?');">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-light rounded-circle border"
                                                            title="–í–∏–¥–∞–ª–∏—Ç–∏">
                                                        üóëÔ∏è
                                                    </button>
                                                </form>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Modal edit -->
                                <div class="modal fade" id="editCommentModal-{{ comment.pk }}" tabindex="-1"
                                     aria-labelledby="editCommentModalLabel-{{ comment.pk }}" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content rounded-4 shadow">
                                            <form method="post" action="{% url 'edit_comment' petition.pk comment.pk %}">
                                                {% csrf_token %}
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editCommentModalLabel-{{ comment.pk }}">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <textarea name="text" class="form-control" rows="4" required>{{ comment.text }}</textarea>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                                    <button type="submit" class="btn btn-primary rounded-pill">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">–ù–µ–º–∞—î –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤. –°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä—à–∏–º!</p>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'petitions/js/petition.js' %}"></script>
<style>
.fade-in {
    animation: fadeIn 0.5s ease-in-out;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}
