{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% block title %}üì¢ {{ petition.title }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-5">

                    {% include "petitions/partials/_petition_header.html" %}
                    <hr class="my-4">
                    {% include "petitions/partials/_petition_support.html" %}
                    {% include "petitions/partials/_petition_actions.html" %}
                    {% include "petitions/partials/_support_button.html" %}

                    {% if request.user == petition.creator or request.user.role in "director admin" %}
                        {% if request.user == petition.creator %}
                            <button type="button"
                                    class="btn btn-danger rounded-pill mt-4"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deletePetitionModal">
                                üóëÔ∏è {% trans "Delete Petition" %}
                            </button>
                        {% endif %}
                    {% endif %}

                    <hr class="my-4">
                    {% include "petitions/partials/_comments.html" %}

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø–µ—Ç–∏—Ü—ñ—ó -->
<div class="modal fade" id="deletePetitionModal" tabindex="-1"
     aria-labelledby="deletePetitionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow modal-delete-confirm">
            <form method="post" action="{% url 'petition_delete' petition.pk %}">
                {% csrf_token %}
                <div class="modal-header bg-danger text-white rounded-top-4">
                    <h5 class="modal-title" id="deletePetitionModalLabel">‚ùó {% trans "Delete Petition" %}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">{% trans "Are you sure you want to delete this petition?" %}</p>
                    <p class="text-muted small mt-2">{% trans "This action cannot be undone." %}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-danger rounded-pill">üóëÔ∏è {% trans "Delete" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% comment %} <script src="{% static 'petitions/js/petition.js' %}"></script> {% endcomment %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const petitionId = "{{ petition.pk }}";
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const socket = new WebSocket(`${ws_scheme}://${window.location.host}/ws/petitions/${petitionId}/`);

    const countElem = document.getElementById("support-count");
    const progressElem = document.getElementById("support-progress");
    const requiredElem = document.getElementById("required-supporters");
    const remainingElem = document.getElementById("remaining-supporters");
    const formWrapper = document.getElementById("support-button-wrapper");

    socket.onmessage = function (event) {
        const data = JSON.parse(event.data);

        // üî¢ –õ—ñ—á–∏–ª—å–Ω–∏–∫ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏
        if (countElem) countElem.textContent = data.supporters_count;

        // üìä –ü—Ä–æ–≥—Ä–µ—Å–±–∞—Ä
        if (progressElem) {
            progressElem.style.width = data.support_percent + "%";
            progressElem.setAttribute("aria-valuenow", data.support_percent);
            progressElem.textContent = data.support_percent + "%";
        }

        // üìà –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏
        if (requiredElem) requiredElem.textContent = data.required_supporters;
        if (remainingElem) remainingElem.textContent = data.remaining_supporters;
    };

    // ‚ö° –û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏
    if (formWrapper) {
        formWrapper.addEventListener("submit", function (e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const isCancel = formData.get("cancel");

            fetch(form.action, {
                method: "POST",
                headers: {
                    "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: formData
            }).then(response => response.json())
              .then(data => {
                if (data.success) {
                    // üîÅ –î–∏–Ω–∞–º—ñ—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏
                    const newForm = document.createElement("form");
                    newForm.method = "post";
                    newForm.action = form.action;
                    newForm.id = "support-form";

                    const csrf = document.createElement("input");
                    csrf.type = "hidden";
                    csrf.name = "csrfmiddlewaretoken";
                    csrf.value = form.querySelector('[name=csrfmiddlewaretoken]').value;
                    newForm.appendChild(csrf);

                    if (!isCancel) {
                        const hidden = document.createElement("input");
                        hidden.type = "hidden";
                        hidden.name = "cancel";
                        hidden.value = "1";
                        newForm.appendChild(hidden);
                    }

                    const btn = document.createElement("button");
                    btn.type = "submit";
                    btn.className = "btn rounded-pill " + (isCancel ? "btn-outline-primary" : "btn-outline-danger");
                    btn.innerHTML = isCancel ? "üôã –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø–µ—Ç–∏—Ü—ñ—é" : "‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫—É";

                    newForm.appendChild(btn);

                    formWrapper.innerHTML = "";
                    formWrapper.appendChild(newForm);
                }
            });
        });
    }
});
</script>
<style>
.fade-in {
    animation: fadeIn 0.5s ease-in-out;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

/* üåô –¢–µ–º–Ω–∞ —Ç–µ–º–∞ */
body.dark-mode .modal-delete-confirm {
    background-color: #1f1f1f;
    color: #f8f9fa;
}
body.dark-mode .modal-delete-confirm .modal-body p,
body.dark-mode .modal-delete-confirm .modal-body .text-muted {
    color: #ccc !important;
}
body.dark-mode .modal-delete-confirm .btn-close {
    filter: invert(1);
}
body.dark-mode .modal-footer .btn-secondary {
    background-color: #444;
    border: none;
}
body.dark-mode .badge {
    color: #fff;
}
body.dark-mode .text-muted {
    color: #ccc !important;
}

/* –ü—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä */
.progress {
    height: 1rem;
    border-radius: 0.5rem;
    background-color: #e9ecef;
    overflow: hidden;
}
.progress-bar {
    transition: width 0.6s ease;
}
body.dark-mode .progress {
    background-color: #2b2b2b;
}
body.dark-mode .progress-bar {
    background-color: #0d6efd;
}

/* –î–ª—è –ø–æ–ª—ñ–≤ —É –ø—ñ–¥—Ç—Ä–∏–º—Ü—ñ, –∫–æ–º–µ–Ω—Ç–∞—Ä—è—Ö */
body.dark-mode input,
body.dark-mode textarea,
body.dark-mode select {
    background-color: #2b2b2b;
    color: #f8f9fa;
    border: 1px solid #555;
}
body.dark-mode input::placeholder,
body.dark-mode textarea::placeholder {
    color: #999;
}
</style>
{% endblock %}
