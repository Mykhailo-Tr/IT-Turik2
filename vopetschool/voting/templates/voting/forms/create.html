{% extends "base.html" %}

{% block title %}Створити голосування{% endblock %}

{% block content %}
<h2>Створити нове голосування</h2>

<form method="post" id="vote-form">
    {% csrf_token %}
    {{ vote_form.as_p }}

    <h4>Варіанти відповіді</h4>
    <div id="formset-container">
        {{ formset.management_form }}
        {% for form in formset %}
            <div class="card p-2 mb-2 formset-form">
                <div class="mb-2">
                    {{ form.text.label }}: {{ form.text }}
                </div>
                <div class="mb-2">
                    {{ form.is_correct }} {{ form.is_correct.label }}
                </div>
                <button type="button" class="btn btn-sm btn-danger remove-option">Видалити</button>
            </div>
        {% endfor %}
    </div>

    <button type="button" class="btn btn-secondary mb-3" id="add-option">+ Додати варіант</button>
    <br>
    <button type="submit" class="btn btn-success">Створити</button>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("formset-container");
    const addBtn = document.getElementById("add-option");
    const totalForms = document.getElementById("id_form-TOTAL_FORMS");

    function updateFormIndexes() {
        const forms = container.querySelectorAll(".formset-form");
        forms.forEach((form, index) => {
            form.querySelectorAll("input, label").forEach(el => {
                if (el.name) {
                    el.name = el.name.replace(/form-\d+-/, `form-${index}-`);
                }
                if (el.id) {
                    el.id = el.id.replace(/form-\d+-/, `form-${index}-`);
                }
                if (el.tagName.toLowerCase() === "label" && el.htmlFor) {
                    el.htmlFor = el.htmlFor.replace(/form-\d+-/, `form-${index}-`);
                }
            });
        });
        totalForms.value = forms.length;
    }

    addBtn.addEventListener("click", function () {
        const currentCount = parseInt(totalForms.value);
        const firstForm = document.querySelector(".formset-form");
        const newForm = firstForm.cloneNode(true);

        newForm.querySelectorAll("input").forEach(input => {
            if (input.type === "checkbox") {
                input.checked = false;
            } else {
                input.value = "";
            }
        });

        container.appendChild(newForm);
        updateFormIndexes();
        attachRemoveHandlers();
    });

    function attachRemoveHandlers() {
        const removeButtons = container.querySelectorAll(".remove-option");
        removeButtons.forEach(button => {
            button.onclick = function () {
                const forms = container.querySelectorAll(".formset-form");
                if (forms.length > 2) {
                    this.closest(".formset-form").remove();
                    updateFormIndexes();
                } else {
                    alert("Має бути щонайменше 2 варіанти.");
                }
            };
        });
    }

    attachRemoveHandlers();
});
</script>
{% endblock %}
