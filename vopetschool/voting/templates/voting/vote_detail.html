{% extends "base.html" %}

{% block title %}{{ vote.title }}{% endblock %}
{% load widget_tweaks %}
{% load vote_extras %}

{% block content %}
<h2>{{ vote.title }}</h2>
<p>{{ vote.description }}</p>

<p><strong>–ê–≤—Ç–æ—Ä:</strong> {{ vote.creator.get_full_name }}{% if request.user == vote.creator %} <span class="badge bg-secondary">–í–∏</span>{% endif %}</p>

{% if vote.end_date %}
    <p><strong>–î–æ—Å—Ç—É–ø–Ω–µ –¥–æ:</strong> {{ vote.end_date|date:"SHORT_DATETIME_FORMAT" }}</p>
{% endif %}

<p><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ vote.get_status_display }}</p>

<hr>

<h4>–í–∞—Ä—ñ–∞–Ω—Ç–∏:</h4>
<ul class="list-group mb-3">
    {% for option in options %}
        <a href="#" class="text-decoration-none option-detail" data-bs-toggle="modal" data-bs-target="#optionModal{{ option.id }}">
            <li class="list-group-item d-flex justify-content-between align-items-center
                {% if user_can_see_votes and vote.has_correct_answer and option.is_correct %}border-success{% endif %}"
                style="{% if user_can_see_votes and vote.has_correct_answer and option.is_correct %}border: 2px solid #198754;{% endif %}">
                
                <span>
                    {{ option.text }}
                    {% if user_can_see_votes and vote.has_correct_answer and option.is_correct %}
                        <span class="badge bg-success">–ü—Ä–∞–≤–∏–ª—å–Ω–∞</span>
                    {% endif %}
                </span>
                <span class="badge bg-primary rounded-pill">{{ option.vote_count }}</span>
            </li>
        </a>

        <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ -->
        <div class="modal fade" id="optionModal{{ option.id }}" tabindex="-1" aria-labelledby="optionModalLabel{{ option.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="optionModalLabel{{ option.id }}">–ì–æ–ª–æ—Å—É–≤–∞–ª–∏ –∑–∞: "{{ option.text }}"</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
                    </div>
                    <div class="modal-body">
                        {% if user_can_see_votes %}
                            {% with option_voters=option_voted_users_dict|get_item:option.id %}
                                {% if option_voters %}
                                    <ul class="list-group">
                                        {% for user in option_voters %}
                                            <li class="list-group-item">{{ user.get_full_name }} ({{ user.role }})</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p>–ù—ñ—Ö—Ç–æ —â–µ –Ω–µ –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞–≤ –∑–∞ —Ü–µ–π –≤–∞—Ä—ñ–∞–Ω—Ç.</p>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <p>–í–∏ –Ω–µ –º–∞—î—Ç–µ –¥–æ—Å—Ç—É–ø—É –¥–æ —Ü—ñ—î—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.</p>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
</ul>


{% if can_vote %}
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-success">–ü—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞—Ç–∏</button>
    </form>
{% elif already_voted %}
    <div class="alert alert-info">–í–∏ –≤–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞–ª–∏ —É —Ü—å–æ–º—É –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—ñ.</div>
{% else %}
    <div class="alert alert-warning">–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è —â–µ –Ω–µ –ø–æ—á–∞–ª–æ—Å—è –∞–±–æ –≤–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å.</div>
{% endif %}

<hr>

<h5 class="mt-4">üßë‚Äçü§ù‚Äçüßë –•—Ç–æ –º–æ–∂–µ –≥–æ–ª–æ—Å—É–≤–∞—Ç–∏:</h5>
<ul>
    {% for user in eligible_users %}
        <li>{{ user.get_full_name }} ({{ user.role }})</li>
    {% empty %}
        <li>–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤</li>
    {% endfor %}
</ul>

<h5 class="mt-4">‚úÖ –•—Ç–æ –≤–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞–≤:</h5>
<ul>
    {% for user in voted_users %}
        <li>{{ user.get_full_name }} ({{ user.role }})</li>
    {% empty %}
        <li>–©–µ –Ω—ñ—Ö—Ç–æ –Ω–µ –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞–≤</li>
    {% endfor %}
</ul>

{% if request.user == vote.creator or request.user.role in "director admin" %}
    <form method="post" action="{% url 'vote_delete' vote.pk %}" onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è?');">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger mt-3">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è</button>
    </form>
{% endif %}

<a href="{% url 'vote_list' %}" class="btn btn-secondary mt-3">‚Üê –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É</a>

<!-- Bootstrap JS (–¥–ª—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
